\n\nCREATE TABLE IF NOT EXISTS stripe_customers (\n  id bigint primary key generated always as identity,\n  user_id uuid references auth.users(id) not null unique,\n  customer_id text not null unique,\n  created_at timestamp with time zone default now(),\n  updated_at timestamp with time zone default now(),\n  deleted_at timestamp with time zone default null\n);
\n\nALTER TABLE stripe_customers ENABLE ROW LEVEL SECURITY;
\n\nCREATE POLICY "Users can view their own customer data"\n    ON stripe_customers\n    FOR SELECT\n    TO authenticated\n    USING (user_id = auth.uid() AND deleted_at IS NULL);
\n\nCREATE TYPE stripe_subscription_status AS ENUM (\n    'not_started',\n    'incomplete',\n    'incomplete_expired',\n    'trialing',\n    'active',\n    'past_due',\n    'canceled',\n    'unpaid',\n    'paused'\n);
\n\nCREATE TABLE IF NOT EXISTS stripe_subscriptions (\n  id bigint primary key generated always as identity,\n  customer_id text unique not null,\n  subscription_id text default null,\n  price_id text default null,\n  current_period_start bigint default null,\n  current_period_end bigint default null,\n  cancel_at_period_end boolean default false,\n  payment_method_brand text default null,\n  payment_method_last4 text default null,\n  status stripe_subscription_status not null,\n  created_at timestamp with time zone default now(),\n  updated_at timestamp with time zone default now(),\n  deleted_at timestamp with time zone default null\n);
\n\nALTER TABLE stripe_subscriptions ENABLE ROW LEVEL SECURITY;
\n\nCREATE POLICY "Users can view their own subscription data"\n    ON stripe_subscriptions\n    FOR SELECT\n    TO authenticated\n    USING (\n        customer_id IN (\n            SELECT customer_id\n            FROM stripe_customers\n            WHERE user_id = auth.uid() AND deleted_at IS NULL\n        )\n        AND deleted_at IS NULL\n    );
\n\nCREATE TYPE stripe_order_status AS ENUM (\n    'pending',\n    'completed',\n    'canceled'\n);
\n\nCREATE TABLE IF NOT EXISTS stripe_orders (\n    id bigint primary key generated always as identity,\n    checkout_session_id text not null,\n    payment_intent_id text not null,\n    customer_id text not null,\n    amount_subtotal bigint not null,\n    amount_total bigint not null,\n    currency text not null,\n    payment_status text not null,\n    status stripe_order_status not null default 'pending',\n    created_at timestamp with time zone default now(),\n    updated_at timestamp with time zone default now(),\n    deleted_at timestamp with time zone default null\n);
\n\nALTER TABLE stripe_orders ENABLE ROW LEVEL SECURITY;
\n\nCREATE POLICY "Users can view their own order data"\n    ON stripe_orders\n    FOR SELECT\n    TO authenticated\n    USING (\n        customer_id IN (\n            SELECT customer_id\n            FROM stripe_customers\n            WHERE user_id = auth.uid() AND deleted_at IS NULL\n        )\n        AND deleted_at IS NULL\n    );
\n\n-- View for user subscriptions\nCREATE VIEW stripe_user_subscriptions WITH (security_invoker = true) AS\nSELECT\n    c.customer_id,\n    s.subscription_id,\n    s.status as subscription_status,\n    s.price_id,\n    s.current_period_start,\n    s.current_period_end,\n    s.cancel_at_period_end,\n    s.payment_method_brand,\n    s.payment_method_last4\nFROM stripe_customers c\nLEFT JOIN stripe_subscriptions s ON c.customer_id = s.customer_id\nWHERE c.user_id = auth.uid()\nAND c.deleted_at IS NULL\nAND s.deleted_at IS NULL;
\n\nGRANT SELECT ON stripe_user_subscriptions TO authenticated;
\n\n-- View for user orders\nCREATE VIEW stripe_user_orders WITH (security_invoker) AS\nSELECT\n    c.customer_id,\n    o.id as order_id,\n    o.checkout_session_id,\n    o.payment_intent_id,\n    o.amount_subtotal,\n    o.amount_total,\n    o.currency,\n    o.payment_status,\n    o.status as order_status,\n    o.created_at as order_date\nFROM stripe_customers c\nLEFT JOIN stripe_orders o ON c.customer_id = o.customer_id\nWHERE c.user_id = auth.uid()\nAND c.deleted_at IS NULL\nAND o.deleted_at IS NULL;
;
